<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecturas del Piránometro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDxesgrk_NpKb93tbxSZUK42LOGGyTfyxg",
      databaseURL: "https://fireesp32-b6a1e-default-rtdb.firebaseio.com",
      projectId: "fireesp32-b6a1e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const potRef = ref(db, 'potenciometro');

    // Función para formatear el timestamp
    function formatearTimestamp(firebaseKey) {
      // Extraer fecha y hora de la clave de Firebase (formato: YYYYMMDD_HHmmss)
      const [fechaStr, horaStr] = firebaseKey.includes('_') 
        ? firebaseKey.split('_') 
        : [firebaseKey.slice(0, 8), firebaseKey.slice(8)];
      
      // Parsear componentes de la fecha
      const anio = fechaStr.slice(0, 4);
      const mes = fechaStr.slice(4, 6);
      const dia = fechaStr.slice(6, 8);
      
      // Parsear componentes de la hora
      const horas = horaStr.slice(0, 2) || '00';
      const minutos = horaStr.slice(2, 4) || '00';
      const segundos = horaStr.slice(4, 6) || '00';
      
      // Crear objeto Date
      const fecha = new Date(
        `${anio}-${mes}-${dia}T${horas}:${minutos}:${segundos}`
      );
      
      // Formatear a local string
      return fecha.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    }

    // Configuración inicial del gráfico
    const ctx = document.getElementById('myChart')?.getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Irradiación (W/m²)',
          data: [],
          borderColor: 'orange',
          tension: 0.1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'category',
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 45,
              font: { size: 10 },
              callback: function(value) {
                return value.split(' ')[1]; // Mostrar solo la hora en el gráfico
              }
            },
            title: { display: true, text: 'Hora' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Irradiación (W/m²)' }
          }
        },
        plugins: { 
          legend: { display: true },
          tooltip: {
            callbacks: {
              title: (context) => context[0].label // Mostrar fecha completa en tooltip
            }
          }
        }
      }
    });

    // ... (mantener igual la función calcularEstadisticas)

    onValue(potRef, (snapshot) => {
      const data = snapshot.val();
      const tbody = document.getElementById('datos-body');
      tbody.innerHTML = '';

      // Actualizar tabla
      Object.keys(data).forEach(key => {
        const entrada = data[key];
        const irradiacion = entrada.voltaje * 1000 / 0.1;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatearTimestamp(key)}</td>
          <td>${entrada.adc}</td>
          <td>${entrada.voltaje.toFixed(2)}</td>
          <td>${entrada.porcentaje}</td>
          <td>${irradiacion.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Preparar datos para el gráfico
      const keys = Object.keys(data).sort((a, b) => a.localeCompare(b));
      const lastKeys = keys.slice(-10);

      const chartLabels = [];
      const chartData = [];

      lastKeys.forEach(key => {
        const entrada = data[key];
        chartLabels.push(formatearTimestamp(key));
        chartData.push(entrada.voltaje * 1000 / 0.1);
      });

      // Actualizar gráfico
      chart.data.labels = chartLabels;
      chart.data.datasets[0].data = chartData;
      chart.update('none');

      // ... (mantener igual el resto del código para estadísticas)
    });
  </script>
  <style>
    /* Mantener igual los estilos */
    td:first-child { white-space: nowrap; } /* Para evitar wraps en el timestamp */
  </style>
</head>
<body>
  <!-- Mantener igual el HTML -->
</body>
</html>